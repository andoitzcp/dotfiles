import pandas as pd
from alive_progress import alive_bar

# Path to files root directory
path = '/mnt/d/Users/andoitz.campo/Documents/IBD/cuadres/exp0008x-230405/'

# Exported CSV list to be read
dict_xprt = {'p_val': 'export_sap_2017_v1_val.csv',
            'p_qty':'export_sap_2017_v1_qty.csv',
            'c': 'export_sac_2017_v1.csv'}

# CSV list of filter to be applied
dict_fltr = {'drop_ceco': '/mnt/d/Users/andoitz.campo/Documents/IBD/utils/forbiden_cecos.csv',
            'drop_cebe': '/mnt/d/Users/andoitz.campo/Documents/IBD/utils/forbiden_cebes.csv'}

# Test definitions
dict_test = {'Actual': {},
             'Prev_Year_Actual': {},
             'Actual_VS_Prev_Year_Act': {},
             'Quantity': {},
             'Prev_Year_Quantity': {},
             'Actual_VS_Pre_Year_Qty': {}}

# Agroupations
groups = ['COMPANY', 'CECO', 'CEBE']

# Data types specifications
datatypes = {'YEAR': str,
          'COMPANY': str,
          'CECO': str,
          'CEBE': str,
          'ACTUALC': float,
          'AP_YEAR': float,
          'AVSAP_YEAR': float,
          'QUANTITY': float,
          'QP_YEAR': float,
          'QVSQP_YEAR': float,
          'ENE' : float,
          'FEB' : float,
          'MAR' : float,
          'ABR' : float,
          'MAY' : float,
          'JUN' : float,
          'JUL' : float,
          'AGO' : float,
          'SEP' : float,
          'OCT' : float,
          'NOV' : float,
          'DIC' : float}

dict_dfs = {}
# Function that reads the handled CSV files.
def ft_readfiles(path, dict_xprt, dict_fltr, datatypes):
    n = len(dict_xprt) + len(dict_fltr)
    print("Reading CSV exported files")
    with alive_bar(n, bar='classic2', spinner='twirls') as bar:
        for key in dict_xprt:
            d = path + dict_xprt[key]
            df = pd.read_csv(d, sep=";", decimal=",", dtype=datatypes)
            dict_dfs[key] = df
            print(key, " readed. File name:", dict_xprt[key])
            bar()
        for key in dict_fltr:
            df = pd.read_csv(dict_fltr[key], sep=";", dtype=datatypes)
            dict_dfs[key] = df
            print(key, " readed. File name:", dict_fltr[key])
            bar()

def ft_joindfs(left_df, right_df, key, how):
    with alive_bar(1, bar=None, spinner='twirls') as bar:
        p = pd.merge(dict_dfs[left_df], dict_dfs[right_df], on=key, how=how)
        tmp_dict = {'p': p}
        dict_dfs.update(tmp_dict)
        print(left_df, 'and', right_df, 'joined at', key, 'as', how)
        bar()

def ft_droplmnts(main_dfn, drop_dfn):
    with alive_bar(1, bar=None, spinner='twirls') as bar:
        tmp_mdf = dict_dfs[main_dfn].copy()
        tmp_ddf = dict_dfs[drop_dfn].copy()
        header = list(tmp_ddf.columns.values).pop(0)
        main_df = tmp_mdf[~tmp_mdf[header].isin(tmp_ddf[header])]
        del tmp_mdf, tmp_ddf
        dict_dfs.update({main_dfn: main_df})
        print('Listed', header, 'droped.')
        bar()

def ft_utest(test, tmp_dfp, src_dfc, fp, fc):
    cols_p = groups.copy()
    cols_p.append(fp)
    cols_c = groups.copy()
    cols_c.append(fc)
    dfp = tmp_dfp.copy()
    dfp = tmp_dfp.loc[:, cols_p]
    dfc = src_dfc.copy()
    dfc = src_dfc.loc[:, cols_c]
    dict_test[test].update({'p': dfp})
    dict_test[test].update({'c': dfc})
    dict_test[test].update({'fp': fp})
    dict_test[test].update({'fc': fc})
    del tmp_dfp

def ft_dfcmp():
    n = len(dict_test) * len(groups)
    with alive_bar(n, bar='classic2', spinner='twirls') as bar:
        for test in dict_test:
            print(f'\t {test}.\n')
            for group in groups:
                out_name = './out/' + test + group + '.csv'
                tmp_dict = dict_test[test]
                tmp_dfc = tmp_dict['c'].groupby(group).sum(numeric_only=True).reset_index()
                tmp_dfp = tmp_dict['p'].groupby(group).sum(numeric_only=True).reset_index()
                cmp = pd.merge(tmp_dfc,
                               tmp_dfp,
                               on=group,
                               how='left')
                cmp['DIFF'] = cmp[tmp_dict['fc']] + cmp[tmp_dict['fp']]
                tot_rows = cmp['DIFF'].count()
                ok_rows = cmp.loc[cmp['DIFF'] < 1, 'DIFF'].count()
                if ok_rows == tot_rows:
                    isok = '\033[92m[OK]\033[0m'
                else:
                    isok = '\033[91m[NOK]\033[0m'
                cmp.to_csv(out_name)
                print(f'\t\t {group}: {ok_rows}/{tot_rows}\t{isok}\n')
                del cmp, tmp_dfc, tmp_dfp
                bar()

### Script instructions starts here ###

ft_readfiles(path, dict_xprt, dict_fltr, datatypes) # Reads CSVs
#ft_joindfs('p_val', 'p_qty', 'CECO', 'inner') # joins tables
ft_droplmnts('p_val', 'drop_ceco') # Drops CECOs
ft_droplmnts('p_val', 'drop_cebe') # Drops CEBEs
ft_droplmnts('p_qty', 'drop_ceco') # Drops CECOs
ft_droplmnts('p_qty', 'drop_cebe') # Drops CEBEs

#Transformations
# TEST 1: Actual
tmp_df = dict_dfs['p_val'].copy()
tmp_df = tmp_df.loc[tmp_df['YEAR'] == '2017']
tmp_df['P'] = tmp_df.loc[:, 'ENE':'SEP'].sum(axis=1)
ft_utest('Actual', tmp_df, dict_dfs['c'], 'P', 'ACTUALC')

# TEST 2: Previous year
tmp_df = dict_dfs['p_val'].copy()
tmp_df = tmp_df.loc[tmp_df['YEAR'] == '2016']
tmp_df['P'] = tmp_df.loc[:, 'ENE':'SEP'].sum(axis=1)
ft_utest('Prev_Year_Actual', tmp_df, dict_dfs['c'], 'P', 'AP_YEAR')

# TEST 3: Actual VS Previous Year
tmp_df = dict_dfs['p_val'].copy()
tmp_df['TMP'] = tmp_df.loc[:, 'ENE':'SEP'].sum(axis=1)
tmp_df = tmp_df.pivot(index=['COMPANY', 'CECO', 'CEBE'],
                      columns='YEAR',
                      values=['TMP'])
tmp_df.columns = tmp_df.columns.droplevel()
tmp_df = tmp_df.rename_axis(None, axis=1)
tmp_df = tmp_df.reset_index()
tmp_df['P'] = tmp_df['2017'] - tmp_df['2016']
ft_utest('Actual_VS_Prev_Year_Act', tmp_df, dict_dfs['c'], 'P', 'AVSAP_YEAR')

# TEST 4: Quantity 
tmp_df = dict_dfs['p_qty'].copy()
tmp_df = tmp_df.loc[tmp_df['YEAR'] == '2017']
tmp_df['P'] = tmp_df.loc[:, 'ENE':'SEP'].sum(axis=1)
ft_utest('Quantity', tmp_df, dict_dfs['c'], 'P', 'QUANTITY')

# TEST 5: Quantity Previous year
tmp_df = dict_dfs['p_qty'].copy()
tmp_df = tmp_df.loc[tmp_df['YEAR'] == '2016']
tmp_df['P'] = tmp_df.loc[:, 'ENE':'SEP'].sum(axis=1)
ft_utest('Prev_Year_Quantity', tmp_df, dict_dfs['c'], 'P', 'QP_YEAR')

# TEST 6: Quantity VS Quantity Previous Year
tmp_df = dict_dfs['p_qty'].copy()
tmp_df['TMP'] = tmp_df.loc[:, 'ENE':'SEP'].sum(axis=1)
tmp_df = tmp_df.pivot(index=['COMPANY', 'CECO', 'CEBE'],
                      columns='YEAR',
                      values=['TMP'])
tmp_df.columns = tmp_df.columns.droplevel()
tmp_df = tmp_df.rename_axis(None, axis=1)
tmp_df = tmp_df.reset_index()
tmp_df['P'] = tmp_df['2017'] - tmp_df['2016']
ft_utest('Actual_VS_Pre_Year_Qty', tmp_df, dict_dfs['c'], 'P', 'QVSQP_YEAR')

#print(dict_test)
ft_dfcmp()

# Some formating
#pd.set_option('display.max_rows', outp.shape[0]+1)
#pd.set_option('display.max_rows', outc.shape[0]+1)
#pd.options.display.float_format = '{:,.2f}'.format

#print(out)
