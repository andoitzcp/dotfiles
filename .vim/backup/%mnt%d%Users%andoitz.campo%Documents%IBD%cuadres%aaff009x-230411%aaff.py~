import pandas as pd

# Data types specifications
datatypes = {'COMPANY': str,
             'AAFF': str,
             'NACT': str,
             'CL_MOV': str,
             'ORDER': str,
             'CECO': str,
             'VAL': float}

# Put here the CSV files that are going to be analyzed
dfp_anek = pd.read_csv('./export_sap_anek.csv', sep=";", decimal=",", dtype=datatypes)
dfp_anep = pd.read_csv('./export_sap_anep.csv', sep=";", decimal=",", dtype=datatypes)
dfc = pd.read_csv('./export_sac_2016_2016_v1.csv', sep=";", decimal=",", dtype=datatypes)
dfcl = pd.read_csv('./export_sap_clmov.csv', sep=";", decimal=",", dtype=datatypes)
dfp_aufk = pd.read_csv('./export_sap_aufk.csv', sep=";", decimal=",", dtype=datatypes)

# Security forbiden element lists
f_CECOs = ['AB000',
           'AB001',
           'AB002',
           'AB100',
           'AC000',
           'AC100',
           'AD000',
           'AE000',
           'AE800',
           'AJ000',
           'AK000',
           'CB220',
           'CF92E',
           'CH211',
           'CL010',
           'DI300',
           'GE000',
           'GF030',
           'GF300',
           'GF400',
           'GF500',
           'GI000',
           'GI600']

f_CEBEs = ['AB000',
           'AB002',
           'AB100',
           'AC000',
           'AC100',
           'AD000',
           'AE000',
           'AE800',
           'AJ000',
           'CL030',
           'CL040',
           'CL060',
           'SPRA100001',
           'SPRA300005',
           'SPRA300007',
           'ZR000']

# Join tables
dfp_anek.to_csv('./out/dfp_anek.csv')
dfp_anep.to_csv('./out/dfp_anep.csv')
dfp = pd.merge(dfp_anek, dfp_anep, left_on=['AAFF', 'NACT'], right_on=['AAFF', 'NACT'], how='left')
dfp.to_csv('./out/dfp1.csv')
dfp = pd.merge(dfp, dfp_aufk, on='ORDER', how='left')
dfp.to_csv('./out/dfp2.csv')

# Drop forbidden elements of the lists above
dfp = dfp[~dfp['CL_MOV'].isin(dfcl['CL_MOV'])]

# Transformation of SAP export
outp = dfp.loc[:, ['CECO', 'VAL']].groupby(['CECO']).sum().reset_index()
slicedf = dfp.copy()
slicedf.to_csv('out.csv')

# Transformation of SAC export
outc = dfc.loc[:,['CECO', 'VALC']].groupby(['CECO']).sum().reset_index()

# Merge both SAP and SAC transformed tables and calculate the difference
out = pd.merge(outc, outp, on='CECO', how='left')
out['diff'] = out['VALC'] - out['VAL']


# Some formating
pd.set_option('display.max_rows', outp.shape[0]+1)
pd.set_option('display.max_rows', outc.shape[0]+1)
pd.options.display.float_format = '{:,.2f}'.format

print(out)
